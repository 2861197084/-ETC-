# ETC 交通流量数据处理说明

## 📁 目录结构

```
data/
├── README.md                    # 本说明文档
├── clean_data.py               # 数据清洗脚本
├── expand_data.py              # 数据扩充脚本
├── 202312（交通流量）/          # 2023年12月原始数据
├── 202401(交通流量）/           # 2024年1月原始数据
├── output/                      # 清洗后的数据（按天保存）
└── expanded/                    # 扩充后的数据（按天保存）
```

---

## 📊 数据字段说明

| 字段名 | 中文名 | 类型 | 说明 |
|--------|--------|------|------|
| `GCXH` | 过车序号 | STRING | 唯一标识，格式如 `G320300109155641578` |
| `XZQHMC` | 行政区划名称 | STRING | 区县名称，如 `铜山县`、`睢宁县` |
| `KKMC` | 卡口名称 | STRING | 监测卡口全称，含路段信息 |
| `FXLX` | 方向类型 | STRING | `1`=上行/入城，`2`=下行/出城 |
| `GCSJ` | 过车时间 | DATETIME | 车辆通过时间，格式 `YYYY-MM-DD HH:MM:SS` |
| `HPZL` | 号牌种类 | STRING | `01`=蓝牌, `02`=黄牌, `51`/`52`=大型车, `UNKNOWN`=未知 |
| `HP` | 号牌号码 | STRING | 脱敏车牌，格式如 `苏C3J***` |
| `CLPPXH` | 车辆品牌型号 | STRING | 车辆品牌，如 `奥迪牌`、`UNKNOWN` |

---

## 🔧 第一步：数据清洗 (clean_data.py)

### 问题背景

原始数据存在以下问题：
1. **编码问题**：CSV 文件使用 GBK 编码，直接读取出现中文乱码
2. **列名不统一**：车牌列在不同文件中命名为 `HP` 或 `SUBSTR(HPHM,1,4)||'***'`
3. **文件格式混乱**：12月为 CSV，1月为 XLSX
4. **文件名与内容不匹配**：如 `to_yqy_12018.csv` 实际包含12月17日数据
5. **缺失值不统一**：使用 `-` 或空值表示缺失

### 清洗策略

```python
# 1. 编码处理
df = pd.read_csv(file, encoding='gb18030')  # CSV 文件
df = pd.read_excel(file)                     # XLSX 文件

# 2. 列名标准化
column_mapping = {
    "SUBSTR(HPHM,1,4)||'***'": "HP",
    "'G'||GCXH": "GCXH",
    "TO_CHAR(GCSJ,...)": "GCSJ"
}

# 3. 缺失值标准化
df['HPZL'] = df['HPZL'].replace('-', 'UNKNOWN')
df['CLPPXH'] = df['CLPPXH'].replace('-', 'UNKNOWN')

# 4. 按实际日期分组保存（基于 GCSJ 字段）
```

### 运行方式

```bash
cd data
python3 clean_data.py
```

### 输出结果

- **输出目录**: `data/output/`
- **文件命名**: `YYYY-MM-DD.csv`（如 `2023-12-01.csv`）
- **编码格式**: UTF-8 with BOM
- **总文件数**: 56 个
- **总记录数**: 1,019,147 条

### 原始数据覆盖情况

| 月份 | 原有日期 | 缺失日期 |
|------|----------|----------|
| 2023年12月 | 1-17, 22-30 日 | 18-21, 31 日 |
| 2024年1月 | 1-12, 14-31 日 | 13 日 |

> ⚠️ 缺失日期是原始数据本身缺失，非清洗脚本问题

---

## 📈 第二步：数据扩充 (expand_data.py)

### 扩充目标

满足大数据存储场景需求：**每秒产生 50 条数据**

| 参数 | 值 |
|------|-----|
| 每秒记录数 | 50 条 |
| 每天记录数 | 4,320,000 条 |
| 总天数 | 62 天 |
| 总记录数 | **约 2.68 亿条** |

### 扩充策略

#### 1. 特征学习

从现有 56 天数据中提取统计分布：

```
特征提取结果示例:
├── 行政区划分布: 铜山县(28%), 睢宁县(23%), 新沂市(15%)...
├── 方向分布: 上行(87%), 下行(13%)
├── 号牌种类分布: 黄牌(70%), 蓝牌(21%), 大型车(7%)...
├── 车牌前缀: 苏C, 鲁Q, 皖L, 豫N 等 2347 种
├── 车辆品牌: 从现有数据中提取
└── 时间分布: 按小时统计流量权重（模拟早晚高峰）
```

#### 2. 已有日期扩充

对于已有数据的日期：
1. **保留全部原始数据**
2. **按原始数据特征分布**生成补充记录
3. 合并后按时间排序

```
示例: 2023-12-01
原始数据: 71,432 条
目标数量: 4,320,000 条
补充生成: 4,248,568 条（保持相同特征分布）
```

#### 3. 缺失日期生成

对于缺失的日期（18-21, 31, 13日）：
1. 查找前后 7 天有数据的文件作为参考
2. 提取参考文件的特征分布
3. 完全生成虚拟数据

#### 4. 时间分布模拟

```
每天 4,320,000 条记录分配:
├── 按小时加权分配（基于历史数据统计）
│   ├── 凌晨 0-5点: 流量较低 (~3%)
│   ├── 早高峰 7-9点: 流量较高 (~15%)
│   ├── 日间 10-16点: 流量中等 (~8%)
│   └── 晚高峰 17-19点: 流量较高 (~12%)
└── 每小时内均匀分布到每秒（约50条/秒）
```

#### 5. 字段生成规则

| 字段 | 生成方式 |
|------|----------|
| `GCXH` | 递增序号，格式 `G320300200000000001` |
| `XZQHMC` | 按历史权重随机选择 |
| `KKMC` | 从对应区划的卡口列表中随机选择 |
| `FXLX` | 按历史权重随机（1 或 2）|
| `GCSJ` | 日期 + 均匀分布的时分秒 |
| `HPZL` | 按历史权重随机 |
| `HP` | 随机前缀 + 2位字母数字 + `***` |
| `CLPPXH` | 从历史品牌列表随机选择 |

### 运行方式

```bash
cd data

# 完整运行（每秒50条，62天，约2.68亿条）
python3 expand_data.py --rps 50

# 测试模式（只处理前3天）
python3 expand_data.py --rps 50 --test

# 自定义每秒记录数
python3 expand_data.py --rps 10

# 指定特定日期
python3 expand_data.py --rps 50 --dates 2023-12-18 2023-12-19 2023-12-20
```

### 命令行参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--rps` | 每秒生成的记录数 | 50 |
| `--test` | 测试模式，只处理前3天 | False |
| `--dates` | 指定要处理的日期列表 | 全部62天 |

### 输出结果

- **输出目录**: `data/expanded/`
- **文件命名**: `YYYY-MM-DD.csv`
- **每文件记录数**: 约 4,320,000 条（每秒50条时）

---

## 🚀 快速开始

### 完整流程

```bash
# 1. 进入数据目录
cd data

# 2. 运行数据清洗
python3 clean_data.py

# 3. 运行数据扩充（测试）
python3 expand_data.py --rps 10 --test

# 4. 确认无误后，运行完整扩充
python3 expand_data.py --rps 50
```

### 依赖安装

```bash
pip install pandas numpy openpyxl
```

---

## 📋 数据质量说明

### 原始数据保留
- 清洗后的数据完整保留原始记录
- 扩充时优先保留原始数据，再补充生成

### 虚拟数据特征
- 基于真实数据的统计分布生成
- 保持区划、卡口、时间等维度的分布特征
- 车牌号为虚拟生成（脱敏格式）

### 不进行去重
- 原始数据中可能存在的重复记录被保留
- 扩充数据与原始数据可能存在相似记录

---

## 📈 数据统计

### 清洗后数据 (output/)

| 指标 | 值 |
|------|-----|
| 文件数量 | 56 个 |
| 总记录数 | 1,019,147 条 |
| 日期范围 | 2023-12-01 ~ 2024-01-31 |
| 缺失天数 | 6 天 |

### 扩充后数据 (expanded/)

| 指标 | 值 (每秒50条) |
|------|-----|
| 文件数量 | 62 个 |
| 每天记录数 | 4,320,000 条 |
| 总记录数 | 约 2.68 亿条 |
| 日期范围 | 2023-12-01 ~ 2024-01-31（完整） |

---


