# ETC 大数据管理平台 - 后端开发待实现清单

> 文档版本：v1.0  
> 更新日期：2025-12-18  
> 用途：后端开发参考，列出所有待实现的 API 接口和实体类

---

## 一、当前实现状态总览

### 已实现

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/auth/login` | POST | Mock 登录 |
| `/api/user/info` | GET | Mock 用户信息 |
| `/api/record/page` | GET/POST | HBase 分页查询 |
| `/api/stats/realtime/count` | GET | 实时总数 |
| `/api/stats/province/rank` | GET | 省份排行 |
| `/api/stats/gantry/rank` | GET | 门架排行 |
| `/api/stats/map/heat` | GET | 热力图数据 |
| `/api/stats/predict/congestion` | GET | 拥堵预测(Mock) |
| `/api/stats/test/alert` | GET | WebSocket 告警测试 |

### 现有实体类

- `EtcRecord.java` - 需要重构

---

## 二、待实现 API 接口

### 2.1 用户认证模块 (`/api/auth/*`)

| 接口 | 方法 | 请求参数 | 响应数据 | 说明 |
|------|------|----------|----------|------|
| `/api/auth/login` | POST | `{userName, password}` | `{token, refreshToken, expires}` | 真实登录验证 |
| `/api/auth/logout` | POST | - | - | 登出 |
| `/api/auth/refresh` | POST | `{refreshToken}` | `{token, refreshToken}` | 刷新 Token |
| `/api/user/info` | GET | - | `{id, username, nickname, avatar, roles, permissions}` | 获取用户信息 |
| `/api/user/list` | GET | `{current, size, userName?, status?}` | 分页列表 | 用户列表 |
| `/api/role/list` | GET | `{current, size}` | 分页列表 | 角色列表 |
| `/api/v3/system/menus` | GET | - | 菜单树 | 系统菜单 |

### 2.2 管理员-实时数据 (`/admin/realtime/*`)

| 接口 | 方法 | 请求参数 | 响应数据 | 说明 |
|------|------|----------|----------|------|
| `/admin/realtime/clone-plates` | GET | `{status?, page?, pageSize?}` | `{list, total}` | 套牌车检测列表 |
| `/admin/realtime/clone-plates/{id}` | PUT | `{status, remark?}` | - | 处理套牌车 |
| `/admin/realtime/violations` | GET | `{type?, status?, startTime?, endTime?, page?, pageSize?}` | `{list, total}` | 违规列表 |
| `/admin/realtime/violations/{id}` | PUT | `{status, remark?}` | - | 处理违规 |
| `/admin/realtime/pressure-warnings` | GET | - | 预警列表 | 站口压力预警 |
| `/admin/realtime/daily-stats` | GET | - | `{totalFlow, totalRevenue, avgSpeed, onlineDevices, abnormalEvents}` | 今日统计 |
| `/admin/realtime/flow` | GET | - | 流量数据 | 实时流量 |

### 2.3 管理员-数据查询 (`/admin/query/*`)

| 接口 | 方法 | 请求参数 | 响应数据 | 说明 |
|------|------|----------|----------|------|
| `/admin/query/records` | GET | `{plateNumber?, checkpointId?, startTime?, endTime?, vehicleType?, page?, pageSize?}` | `{list, total}` | 通行记录查询 |
| `/admin/query/records/{id}` | GET | - | PassRecord | 记录详情 |
| `/admin/query/text2sql` | POST | `{query, context?}` | `{sql, explanation, confidence}` | 自然语言转SQL |
| `/admin/query/execute` | POST | `{sql}` | `{columns, data, total}` | 执行SQL |
| `/admin/query/history` | GET | `{page?, pageSize?}` | `{list, total}` | 查询历史 |
| `/admin/query/export` | POST | `{sql, format}` | Blob | 导出结果 |
| `/admin/query/options/checkpoints` | GET | - | `[{label, value}]` | 卡口选项 |
| `/admin/query/options/vehicle-types` | GET | - | `[{label, value}]` | 车辆类型选项 |

### 2.4 管理员-地图 (`/admin/map/*`)

| 接口 | 方法 | 请求参数 | 响应数据 | 说明 |
|------|------|----------|----------|------|
| `/admin/map/checkpoints` | GET | `{type?, region?, status?}` | Checkpoint[] | **19个出市卡口**（固定） |
| `/admin/map/checkpoints/{id}` | GET | - | Checkpoint | 卡口详情 |
| `/admin/map/stations` | GET | `{region?, roadLevel?}` | Station[] | **市内监测站点**（路径规划用） |
| `/admin/map/stations/{id}` | GET | - | Station | 站点详情 |
| `/admin/map/heatmap` | GET | `{startTime?, endTime?}` | `[{lng, lat, count}]` | 热力图 |
| `/admin/map/pressure` | GET | - | CheckpointPressure[] | 卡口压力列表 |
| `/admin/map/events` | GET | `{type?, limit?}` | 事件列表 | 实时事件 |

### 2.5 管理员-车流量预测 (`/admin/predict/*`) - **课程核心**

| 接口 | 方法 | 请求参数 | 响应数据 | 说明 |
|------|------|----------|----------|------|
| `/admin/predict/checkpoint/{id}` | GET | `{hours?}` | `{checkpointId, predictions[{time, flow, confidence}]}` | 单卡口流量预测 |
| `/admin/predict/checkpoints` | GET | `{hours?}` | `[{checkpointId, name, currentFlow, predictedFlow, trend}]` | 所有卡口预测汇总 |
| `/admin/predict/history/{id}` | GET | `{days?}` | `{checkpointId, history[{date, hourlyFlow[]}]}` | 历史流量数据 |

### 2.6 车主-通行记录 (`/owner/records/*`)

| 接口 | 方法 | 请求参数 | 响应数据 | 说明 |
|------|------|----------|----------|------|
| `/owner/records/pass` | GET | `{page?, pageSize?, startTime?, endTime?}` | `{list, total}` | 通行记录 |
| `/owner/records/pass/{id}` | GET | - | PassRecord | 记录详情 |
| `/owner/records/search` | GET | 查询参数 | `{list, total}` | 搜索记录 |
| `/owner/records/text2sql` | POST | `{query}` | `{sql, explanation}` | 自然语言查询 |
| `/owner/records/execute` | POST | `{sql}` | `{columns, data, total}` | 执行查询 |

### 2.6 车主-账单 (`/owner/bills/*`)

| 接口 | 方法 | 请求参数 | 响应数据 | 说明 |
|------|------|----------|----------|------|
| `/owner/bills/summary` | GET | `{month, vehicleId?}` | BillSummary | 账单汇总 |
| `/owner/bills/details` | GET | `{month, vehicleId?, page?, pageSize?}` | `{list, total}` | 账单明细 |
| `/owner/bills/export` | GET | `{month, vehicleId?, format}` | Blob | 导出账单 |
| `/owner/bills/invoice` | POST | `{month, vehicleId?, invoiceType, invoiceTitle, taxNumber?, email}` | - | 申请发票 |
| `/owner/bills/invoices` | GET | `{page?, pageSize?}` | `{list, total}` | 发票记录 |

### 2.7 车主-告警 (`/owner/alerts/*`)

| 接口 | 方法 | 请求参数 | 响应数据 | 说明 |
|------|------|----------|----------|------|
| `/owner/alerts` | GET | `{type?, isRead?, page?, pageSize?}` | `{list, total, unreadCount}` | 告警列表 |
| `/owner/alerts/{id}` | GET | - | Alert | 告警详情 |
| `/owner/alerts/{id}/read` | PUT | - | - | 标记已读 |
| `/owner/alerts/read-all` | PUT | - | - | 全部已读 |
| `/owner/alerts/{id}/dismiss` | PUT | - | - | 忽略告警 |
| `/owner/alerts/appeal` | POST | `{alertId, appealType, reason, proofImages?}` | Appeal | 提交申诉 |
| `/owner/alerts/appeals` | GET | `{status?, page?, pageSize?}` | `{list, total}` | 申诉列表 |
| `/owner/alerts/appeals/{id}` | GET | - | Appeal | 申诉详情 |

### 2.8 车主-地图 (`/owner/map/*`)

| 接口 | 方法 | 请求参数 | 响应数据 | 说明 |
|------|------|----------|----------|------|
| `/owner/map/vehicles` | GET | - | OwnerVehicle[] | 绑定车辆 |
| `/owner/map/trajectory` | GET | `{vehicleId, startTime, endTime}` | VehicleTrajectory | 车辆轨迹 |
| `/owner/map/stats` | GET | `{vehicleId?, month?}` | `{totalTrips, totalFee, totalDistance, avgSpeed}` | 个人统计 |

---

## 三、待实现实体类

### 3.1 用户相关

```java
// SysUser.java
@Data
@TableName("sys_user")
public class SysUser {
    @TableId(type = IdType.AUTO)
    private Long id;
    private String username;
    private String password;
    private String nickname;
    private String email;
    private String phone;
    private String avatar;
    private Integer status;        // 0-禁用 1-启用
    private String userType;       // admin/owner
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}

// SysRole.java
@Data
@TableName("sys_role")
public class SysRole {
    @TableId(type = IdType.AUTO)
    private Long id;
    private String roleCode;
    private String roleName;
    private String description;
    private Integer status;
    private LocalDateTime createdAt;
}
```

### 3.2 车辆相关

```java
// Vehicle.java
@Data
@TableName("vehicle")
public class Vehicle {
    @TableId(type = IdType.ASSIGN_UUID)
    private String id;
    private String plateNumber;
    private String plateColor;     // blue/yellow/green/white/black
    private String vehicleType;    // small/medium/large/extra_large/motorcycle
    private String brand;
    private String model;
    private String color;
    private Long ownerId;
    private String ownerName;
    private String ownerPhone;
    private String etcCardNo;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}

// OwnerVehicle.java (扩展 Vehicle，添加绑定信息)
@Data
public class OwnerVehicle extends Vehicle {
    private LocalDateTime bindTime;
    private Boolean isDefault;
}
```

### 3.3 卡口相关

```java
// Checkpoint.java
@Data
@TableName("checkpoint")
public class Checkpoint {
    @TableId(type = IdType.ASSIGN_UUID)
    private String id;
    private String name;
    private String code;
    private BigDecimal longitude;
    private BigDecimal latitude;
    private String region;
    private String type;           // entrance/exit/toll
    private String status;         // online/offline/maintenance
    private Integer maxCapacity;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}
```

### 3.4 通行记录

```java
// PassRecord.java (重构原 EtcRecord)
@Data
@TableName("pass_record")
public class PassRecord {
    @TableId(type = IdType.ASSIGN_UUID)
    private String id;
    private String vehicleId;
    private String plateNumber;
    private String vehicleType;
    private String entryCheckpointId;
    private String entryCheckpointName;
    private LocalDateTime entryTime;
    private String exitCheckpointId;
    private String exitCheckpointName;
    private LocalDateTime exitTime;
    private BigDecimal distance;
    private BigDecimal avgSpeed;
    private BigDecimal fee;
    private String paymentStatus;  // paid/unpaid/pending
    private String paymentMethod;  // etc/cash/mobile
    private String status;         // normal/abnormal/pending
    private String remark;
    private LocalDateTime createdAt;
}
```

### 3.5 违规相关

```java
// Violation.java
@Data
@TableName("violation")
public class Violation {
    @TableId(type = IdType.ASSIGN_UUID)
    private String id;
    private String vehicleId;
    private String plateNumber;
    private String violationType;  // clone_plate/speeding/wrong_way/red_light/no_seatbelt/other
    private String checkpointId;
    private String checkpointName;
    private LocalDateTime detectTime;
    private String description;
    @TableField(typeHandler = JacksonTypeHandler.class)
    private List<String> evidenceImages;
    private String status;         // pending/processing/resolved/dismissed
    private String handler;
    private LocalDateTime handleTime;
    private String handleRemark;
    private LocalDateTime createdAt;
}

// ClonePlateDetection.java
@Data
@TableName("clone_plate_detection")
public class ClonePlateDetection {
    @TableId(type = IdType.ASSIGN_UUID)
    private String id;
    private String plateNumber;
    private Integer confidence;
    @TableField(typeHandler = JacksonTypeHandler.class)
    private List<ConflictRecord> conflictRecords;
    @TableField(typeHandler = JacksonTypeHandler.class)
    private LastLocation lastLocation;
    private String status;         // pending/confirmed/dismissed
    private LocalDateTime createdAt;
    
    @Data
    public static class ConflictRecord {
        private String checkpointId;
        private String checkpointName;
        private String detectTime;
        private BigDecimal longitude;
        private BigDecimal latitude;
    }
    
    @Data
    public static class LastLocation {
        private String checkpointId;
        private String checkpointName;
        private String time;
    }
}
```

### 3.6 告警相关

```java
// Alert.java
@Data
@TableName("alert")
public class Alert {
    @TableId(type = IdType.ASSIGN_UUID)
    private String id;
    private Long userId;
    private String vehicleId;
    private String plateNumber;
    private String alertType;      // fee_unpaid/violation/clone_plate/system
    private String title;
    private String content;
    private Boolean isRead;
    private Boolean needAction;
    private String relatedId;
    private LocalDateTime createdAt;
    private LocalDateTime expireAt;
}

// Appeal.java
@Data
@TableName("appeal")
public class Appeal {
    @TableId(type = IdType.ASSIGN_UUID)
    private String id;
    private Long userId;
    private String alertId;
    private String appealType;     // clone_plate/violation/fee/other
    private String reason;
    @TableField(typeHandler = JacksonTypeHandler.class)
    private List<String> proofImages;
    private String status;         // pending/approved/rejected
    private String result;
    private LocalDateTime handleTime;
    private LocalDateTime createdAt;
}
```

### 3.7 账单相关

```java
// Bill.java
@Data
@TableName("bill")
public class Bill {
    @TableId(type = IdType.ASSIGN_UUID)
    private String id;
    private Long ownerId;
    private String vehicleId;
    private String billMonth;      // yyyy-MM
    private Integer totalCount;
    private BigDecimal totalFee;
    private BigDecimal totalDistance;
    private String paymentStatus;
    private LocalDateTime createdAt;
}

// InvoiceRecord.java
@Data
@TableName("invoice_record")
public class InvoiceRecord {
    @TableId(type = IdType.ASSIGN_UUID)
    private String id;
    private Long ownerId;
    private String billMonth;
    private BigDecimal amount;
    private String invoiceType;    // personal/company
    private String invoiceTitle;
    private String taxNumber;
    private String email;
    private String status;         // pending/processing/completed/failed
    private String invoiceUrl;
    private LocalDateTime createdAt;
}
```

### 3.8 轨迹相关

```java
// VehicleTrajectory.java (DTO，非数据库表)
@Data
public class VehicleTrajectory {
    private String vehicleId;
    private String plateNumber;
    private List<TrajectoryPoint> points;
    private String startTime;
    private String endTime;
    private BigDecimal totalDistance;
}

@Data
public class TrajectoryPoint {
    private BigDecimal longitude;
    private BigDecimal latitude;
    private String time;
    private Integer speed;
    private String checkpointId;
    private String checkpointName;
}
```

---

## 四、枚举类定义

```java
// VehicleTypeEnum.java
public enum VehicleTypeEnum {
    SMALL("small", "小型车"),
    MEDIUM("medium", "中型车"),
    LARGE("large", "大型车"),
    EXTRA_LARGE("extra_large", "特大型车"),
    MOTORCYCLE("motorcycle", "摩托车");
    
    private final String code;
    private final String name;
}

// ViolationTypeEnum.java
public enum ViolationTypeEnum {
    CLONE_PLATE("clone_plate", "套牌车"),
    SPEEDING("speeding", "超速"),
    WRONG_WAY("wrong_way", "逆行"),
    RED_LIGHT("red_light", "闯红灯"),
    NO_SEATBELT("no_seatbelt", "未系安全带"),
    OTHER("other", "其他");
    
    private final String code;
    private final String name;
}

// PassStatusEnum.java
public enum PassStatusEnum {
    NORMAL("normal", "正常"),
    ABNORMAL("abnormal", "异常"),
    PENDING("pending", "待处理");
    
    private final String code;
    private final String name;
}

// CongestionLevelEnum.java
public enum CongestionLevelEnum {
    SMOOTH("smooth", "畅通"),
    LOW("low", "轻度拥堵"),
    MEDIUM("medium", "中度拥堵"),
    HIGH("high", "严重拥堵");
    
    private final String code;
    private final String name;
}

// AlertTypeEnum.java
public enum AlertTypeEnum {
    FEE_UNPAID("fee_unpaid", "费用未缴"),
    VIOLATION("violation", "违规提醒"),
    CLONE_PLATE("clone_plate", "套牌预警"),
    SYSTEM("system", "系统通知");
    
    private final String code;
    private final String name;
}
```

---

## 五、统一响应格式

```java
// ApiResponse.java (已存在，保持不变)
@Data
public class ApiResponse<T> {
    private int code;
    private String msg;
    private T data;

    public static <T> ApiResponse<T> ok(T data) {
        return new ApiResponse<>(200, "success", data);
    }

    public static <T> ApiResponse<T> error(String msg, int code) {
        return new ApiResponse<>(code, msg, null);
    }
}

// PageResult.java (分页响应)
@Data
public class PageResult<T> {
    private List<T> list;
    private Long total;
    private Integer page;
    private Integer pageSize;
}
```

---

## 六、开发优先级建议

### P0 - 核心功能（必须先实现）

1. 用户认证 - 真实登录/用户信息
2. 通行记录查询 - `/admin/query/records`、`/owner/records/pass`
3. 车辆管理 - `/owner/map/vehicles`

### P1 - 重要功能

4. 卡口管理 - `/admin/map/checkpoints`
5. 今日统计 - `/admin/realtime/daily-stats`
6. 账单汇总 - `/owner/bills/summary`

### P2 - 次要功能

7. 违规检测 - `/admin/realtime/violations`
8. 套牌检测 - `/admin/realtime/clone-plates`
9. 告警管理 - `/owner/alerts`

### P3 - 可延后

10. Text2SQL - `/admin/query/text2sql`
11. 申诉功能 - `/owner/alerts/appeal`
12. 发票管理 - `/owner/bills/invoice`

---

> **注意事项**：
> 1. 所有接口统一返回 `ApiResponse<T>` 格式
> 2. 分页参数统一使用 `page`、`pageSize`
> 3. 时间字段统一使用 ISO 8601 格式字符串
> 4. ID 字段除用户表外统一使用 UUID
