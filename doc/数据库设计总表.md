# ETC 大数据管理平台 - 数据库设计总表

> 版本：v1.0 | 更新日期：2025-12-18

---

## 一、MySQL 表结构

### 1.1 sys_user - 系统用户表

```sql
CREATE TABLE `sys_user` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` VARCHAR(50) NOT NULL COMMENT '用户名',
  `password` VARCHAR(255) NOT NULL COMMENT '密码(BCrypt)',
  `nickname` VARCHAR(100) DEFAULT NULL COMMENT '昵称',
  `email` VARCHAR(100) DEFAULT NULL COMMENT '邮箱',
  `phone` VARCHAR(20) DEFAULT NULL COMMENT '手机号',
  `avatar` VARCHAR(255) DEFAULT NULL COMMENT '头像URL',
  `status` TINYINT DEFAULT 1 COMMENT '状态:0-禁用,1-启用',
  `user_type` VARCHAR(20) DEFAULT 'owner' COMMENT '类型:admin/owner',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  KEY `idx_phone` (`phone`),
  KEY `idx_user_type` (`user_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统用户表';
```

### 1.2 sys_role - 角色表

```sql
CREATE TABLE `sys_role` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '角色ID',
  `role_code` VARCHAR(50) NOT NULL COMMENT '角色编码',
  `role_name` VARCHAR(100) NOT NULL COMMENT '角色名称',
  `description` VARCHAR(255) DEFAULT NULL COMMENT '描述',
  `status` TINYINT DEFAULT 1 COMMENT '状态',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_role_code` (`role_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='角色表';
```

### 1.3 sys_user_role - 用户角色关联表

```sql
CREATE TABLE `sys_user_role` (
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `role_id` BIGINT NOT NULL COMMENT '角色ID',
  PRIMARY KEY (`user_id`, `role_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户角色关联表';
```

### 1.4 vehicle - 车辆信息表

```sql
CREATE TABLE `vehicle` (
  `id` VARCHAR(36) NOT NULL COMMENT '车辆ID(UUID)',
  `plate_number` VARCHAR(20) NOT NULL COMMENT '车牌号',
  `plate_color` VARCHAR(10) NOT NULL COMMENT '车牌颜色:blue/yellow/green/white/black',
  `vehicle_type` VARCHAR(20) NOT NULL COMMENT '车辆类型:small/medium/large/extra_large/motorcycle',
  `brand` VARCHAR(50) DEFAULT NULL COMMENT '品牌',
  `model` VARCHAR(50) DEFAULT NULL COMMENT '型号',
  `color` VARCHAR(20) DEFAULT NULL COMMENT '车身颜色',
  `owner_id` BIGINT DEFAULT NULL COMMENT '车主ID',
  `owner_name` VARCHAR(50) DEFAULT NULL COMMENT '车主姓名',
  `owner_phone` VARCHAR(20) DEFAULT NULL COMMENT '车主电话',
  `etc_card_no` VARCHAR(30) DEFAULT NULL COMMENT 'ETC卡号',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_plate_number` (`plate_number`),
  UNIQUE KEY `uk_etc_card_no` (`etc_card_no`),
  KEY `idx_owner_id` (`owner_id`),
  KEY `idx_vehicle_type` (`vehicle_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='车辆信息表';
```

### 1.5 owner_vehicle - 车主车辆绑定表

```sql
CREATE TABLE `owner_vehicle` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '绑定ID',
  `owner_id` BIGINT NOT NULL COMMENT '车主ID',
  `vehicle_id` VARCHAR(36) NOT NULL COMMENT '车辆ID',
  `bind_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '绑定时间',
  `is_default` TINYINT DEFAULT 0 COMMENT '是否默认:0-否,1-是',
  `status` TINYINT DEFAULT 1 COMMENT '状态:0-已解绑,1-绑定中',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_owner_vehicle` (`owner_id`, `vehicle_id`),
  KEY `idx_vehicle_id` (`vehicle_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='车主车辆绑定表';
```

### 1.6 checkpoint - 出市卡口表（19个固定卡口）

```sql
-- 出市/出省卡口，共19个固定点位，用于车流量预测（课程核心要求）
CREATE TABLE `checkpoint` (
  `id` VARCHAR(36) NOT NULL COMMENT '卡口ID',
  `code` VARCHAR(50) NOT NULL COMMENT '卡口编码(如G104-AH-SN)',
  `name` VARCHAR(50) NOT NULL COMMENT '简称(地图标注)',
  `full_name` VARCHAR(200) NOT NULL COMMENT '完整名称',
  `longitude` DECIMAL(10,6) NOT NULL COMMENT '经度',
  `latitude` DECIMAL(10,6) NOT NULL COMMENT '纬度',
  `region` VARCHAR(50) NOT NULL COMMENT '所属区县',
  `type` VARCHAR(20) NOT NULL COMMENT '类型:provincial-省际/municipal-市际',
  `road` VARCHAR(20) NOT NULL COMMENT '所属道路(G104/S253等)',
  `boundary` VARCHAR(50) DEFAULT NULL COMMENT '交界方向(苏皖界/苏鲁界/连云港界等)',
  `status` VARCHAR(20) DEFAULT 'online' COMMENT '状态:online/offline/maintenance',
  `max_capacity` INT DEFAULT 2000 COMMENT '最大通行容量/小时',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_code` (`code`),
  KEY `idx_region` (`region`),
  KEY `idx_type` (`type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='出市卡口表(19个固定)';

-- 初始化19个卡口数据
INSERT INTO `checkpoint` (`id`, `code`, `name`, `full_name`, `longitude`, `latitude`, `region`, `type`, `road`, `boundary`) VALUES
('CP001', 'G104-AH-SN', 'G104苏皖界(睢宁)', '徐州市睢宁县G104北京-福州K873江苏徐州-G104-苏皖界省际卡口', 117.8682, 33.8095, '睢宁县', 'provincial', 'G104', '苏皖界'),
('CP002', 'G310-AH-TS', 'G310苏皖界(铜山)', '徐州市铜山县G310连云港-天水K310江苏徐州-G310-苏皖界省际卡口', 117.1965, 34.1482, '铜山区', 'provincial', 'G310', '苏皖界'),
('CP003', 'S323-LYG-XY', 'S323阿湖卡口(新沂)', '徐州市新沂市s323连徐线K10阿湖卡口-323省道连云港交界市际卡口', 118.6048, 34.3742, '新沂市', 'municipal', 'S323', '连云港界'),
('CP004', 'G311-AH-TS', 'G311苏皖界(铜山)', '徐州市铜山县G311徐州-西峡K207江苏徐州-G311-苏皖界省际卡口', 117.2981, 34.1976, '铜山区', 'provincial', 'G311', '苏皖界'),
('CP005', 'S253-SD-PX', 'S253苏鲁界(沛县)', '徐州市沛县s253郑沛龙线K0江苏徐州-s253-苏鲁界省际卡口', 116.9274, 34.7285, '沛县', 'provincial', 'S253', '苏鲁界'),
('CP006', 'S323-WY-XY', 'S323瓦窑检查站(新沂)', '江苏省徐州市新沂市s323连徐线K96瓦窑检查站市际卡口', 118.2387, 34.3791, '新沂市', 'municipal', 'S323', '市际'),
('CP007', 'S250-SD-PZ', 'S250苏鲁界(邳州)', '徐州市邳州市s250宿邳线K1江苏徐州-s250-苏鲁界省际卡口', 117.8972, 34.2985, '邳州市', 'provincial', 'S250', '苏鲁界'),
('CP008', 'S505-SQ-XY', 'S505宿迁界(新沂)', '徐州市新沂市s505省道K10新沂高速西出口-505省道宿迁界市际卡口', 118.2963, 34.3478, '新沂市', 'municipal', 'S505', '宿迁界'),
('CP009', 'S324-SZ-SN', 'S324桑庄卡口(睢宁)', '徐州市睢宁县S324燕沭睢线K201省道桑庄王马路路口西侧-向东卡口市际卡口', 117.8951, 33.9974, '睢宁县', 'municipal', 'S324', '市际'),
('CP010', 'G518-SD-FX', 'G518马楼公路站(丰县)', '徐州市丰县G518国道K358马楼公路站省际卡口', 116.7583, 34.5692, '丰县', 'provincial', 'G518', '苏鲁界'),
('CP011', 'G237-SD-FX', 'G237荣庄卡口(丰县)', '徐州市丰县G237国道237线K148荣庄卡口省际卡口', 116.5976, 34.6981, '丰县', 'provincial', 'G237', '苏鲁界'),
('CP012', 'G235-MJ-XY', 'G235交界卡口(新沂)', '徐州市新沂市G235国道235K10江苏徐州-G235-交界市际卡口', 118.3482, 34.3795, '新沂市', 'municipal', 'G235', '市际'),
('CP013', 'S251-SD-PZ', 'S251苏鲁界(邳州)', '徐州市邳州市s251枣睢线K5江苏徐州-s251-苏鲁界省际卡口', 117.9683, 34.3192, '邳州市', 'provincial', 'S251', '苏鲁界'),
('CP014', 'LLR-LZ-FX', '梁寨检查站(丰县)', '徐州市丰县鹿梁路K19丰县梁寨检查站市际卡口', 116.6475, 34.7483, '丰县', 'municipal', 'S鹿梁路', '市际'),
('CP015', 'G104-SD-TS', 'G104苏鲁界(铜山)', '徐州市铜山县G104北京-福州K744江苏徐州-G104-苏鲁界省际卡口', 117.0973, 34.2481, '铜山区', 'provincial', 'G104', '苏鲁界'),
('CP016', 'G3-SD-XZ', 'G3京台高速苏鲁界', 'G3京台高速K731江苏高速五大队江苏徐州-G3-苏鲁界省际卡口', 117.4982, 34.7975, '徐州市', 'provincial', 'G3', '苏鲁界'),
('CP017', 'S325-HS-SN', 'S325淮宿线卡口(睢宁)', '江苏省徐州市睢宁县s325淮宿线K63(325省道)63K+100M东侧-向西卡口市际卡口', 117.8982, 33.9965, '睢宁县', 'municipal', 'S325', '市际'),
('CP018', 'S252-AH-SN', 'S252苏皖界(睢宁)', '徐州市睢宁县s252塔双线K56江苏徐州-s252-苏皖界省际卡口', 117.9473, 34.0482, '睢宁县', 'provincial', 'S252', '苏皖界'),
('CP019', 'G206-AH-TS', 'G206苏皖界(铜山)', '徐州市铜山县G206烟台-汕头K816江苏徐州-G206-苏皖界省际卡口', 117.2481, 34.1973, '铜山区', 'provincial', 'G206', '苏皖界');
```

### 1.7 station - 市内监测站点表（用于路径规划）

```sql
-- 市内道路监测站点，用于市内车流量统计和路径规划（额外功能）
CREATE TABLE `station` (
  `id` VARCHAR(36) NOT NULL COMMENT '站点ID',
  `code` VARCHAR(50) NOT NULL COMMENT '站点编码',
  `name` VARCHAR(100) NOT NULL COMMENT '站点名称',
  `longitude` DECIMAL(10,6) NOT NULL COMMENT '经度',
  `latitude` DECIMAL(10,6) NOT NULL COMMENT '纬度',
  `region` VARCHAR(50) NOT NULL COMMENT '所属区县',
  `road_name` VARCHAR(100) DEFAULT NULL COMMENT '所在道路名称',
  `road_level` VARCHAR(20) DEFAULT NULL COMMENT '道路等级:highway/main/secondary/branch',
  `direction` VARCHAR(20) DEFAULT NULL COMMENT '监测方向:both/inbound/outbound',
  `status` VARCHAR(20) DEFAULT 'online' COMMENT '状态',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_code` (`code`),
  KEY `idx_region` (`region`),
  KEY `idx_road_level` (`road_level`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='市内监测站点表';
```

### 1.8 pass_record - 通行记录表（分片表）

```sql
-- 逻辑表结构，实际通过 ShardingSphere 分片存储
CREATE TABLE `pass_record` (
  `id` VARCHAR(36) NOT NULL COMMENT '记录ID(UUID)',
  `vehicle_id` VARCHAR(36) NOT NULL COMMENT '车辆ID',
  `plate_number` VARCHAR(20) NOT NULL COMMENT '车牌号',
  `plate_hash` INT NOT NULL COMMENT '车牌哈希值(分片键)',
  `vehicle_type` VARCHAR(20) NOT NULL COMMENT '车辆类型',
  `entry_checkpoint_id` VARCHAR(36) NOT NULL COMMENT '入口卡口ID',
  `entry_checkpoint_name` VARCHAR(100) DEFAULT NULL COMMENT '入口卡口名称',
  `entry_time` DATETIME NOT NULL COMMENT '入口时间',
  `exit_checkpoint_id` VARCHAR(36) DEFAULT NULL COMMENT '出口卡口ID',
  `exit_checkpoint_name` VARCHAR(100) DEFAULT NULL COMMENT '出口卡口名称',
  `exit_time` DATETIME DEFAULT NULL COMMENT '出口时间',
  `distance` DECIMAL(10,2) DEFAULT NULL COMMENT '行驶里程(km)',
  `avg_speed` DECIMAL(6,2) DEFAULT NULL COMMENT '平均速度(km/h)',
  `fee` DECIMAL(10,2) DEFAULT 0.00 COMMENT '通行费用',
  `payment_status` VARCHAR(20) DEFAULT 'unpaid' COMMENT '支付状态:paid/unpaid/pending',
  `payment_method` VARCHAR(20) DEFAULT NULL COMMENT '支付方式:etc/cash/mobile',
  `status` VARCHAR(20) DEFAULT 'normal' COMMENT '通行状态:normal/abnormal/pending',
  `remark` VARCHAR(255) DEFAULT NULL COMMENT '备注',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_plate_number` (`plate_number`),
  KEY `idx_entry_time` (`entry_time`),
  KEY `idx_exit_time` (`exit_time`),
  KEY `idx_checkpoint` (`entry_checkpoint_id`, `exit_checkpoint_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='通行记录表';
```

### 1.8 violation - 违规记录表

```sql
CREATE TABLE `violation` (
  `id` VARCHAR(36) NOT NULL COMMENT '违规ID(UUID)',
  `vehicle_id` VARCHAR(36) NOT NULL COMMENT '车辆ID',
  `plate_number` VARCHAR(20) NOT NULL COMMENT '车牌号',
  `violation_type` VARCHAR(30) NOT NULL COMMENT '违规类型:clone_plate/speeding/wrong_way/red_light/no_seatbelt/other',
  `checkpoint_id` VARCHAR(36) NOT NULL COMMENT '发现卡口ID',
  `checkpoint_name` VARCHAR(100) DEFAULT NULL COMMENT '卡口名称',
  `detect_time` DATETIME NOT NULL COMMENT '发现时间',
  `description` TEXT DEFAULT NULL COMMENT '违规描述',
  `evidence_images` JSON DEFAULT NULL COMMENT '证据图片URL数组',
  `status` VARCHAR(20) DEFAULT 'pending' COMMENT '处理状态:pending/processing/resolved/dismissed',
  `handler` VARCHAR(50) DEFAULT NULL COMMENT '处理人',
  `handle_time` DATETIME DEFAULT NULL COMMENT '处理时间',
  `handle_remark` VARCHAR(255) DEFAULT NULL COMMENT '处理备注',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_plate_number` (`plate_number`),
  KEY `idx_violation_type` (`violation_type`),
  KEY `idx_status` (`status`),
  KEY `idx_detect_time` (`detect_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='违规记录表';
```

### 1.9 clone_plate_detection - 套牌车检测表

```sql
CREATE TABLE `clone_plate_detection` (
  `id` VARCHAR(36) NOT NULL COMMENT '检测ID(UUID)',
  `plate_number` VARCHAR(20) NOT NULL COMMENT '车牌号',
  `confidence` TINYINT NOT NULL COMMENT '置信度0-100',
  `conflict_records` JSON NOT NULL COMMENT '冲突记录详情',
  `last_location` JSON DEFAULT NULL COMMENT '最后出现位置',
  `status` VARCHAR(20) DEFAULT 'pending' COMMENT '状态:pending/confirmed/dismissed',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_plate_number` (`plate_number`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='套牌车检测表';
```

### 1.10 alert - 告警信息表

```sql
CREATE TABLE `alert` (
  `id` VARCHAR(36) NOT NULL COMMENT '告警ID(UUID)',
  `user_id` BIGINT DEFAULT NULL COMMENT '目标用户ID',
  `vehicle_id` VARCHAR(36) DEFAULT NULL COMMENT '车辆ID',
  `plate_number` VARCHAR(20) DEFAULT NULL COMMENT '车牌号',
  `alert_type` VARCHAR(30) NOT NULL COMMENT '告警类型:fee_unpaid/violation/clone_plate/system',
  `title` VARCHAR(100) NOT NULL COMMENT '告警标题',
  `content` TEXT DEFAULT NULL COMMENT '告警内容',
  `is_read` TINYINT DEFAULT 0 COMMENT '是否已读:0-否,1-是',
  `need_action` TINYINT DEFAULT 0 COMMENT '是否需要处理:0-否,1-是',
  `related_id` VARCHAR(36) DEFAULT NULL COMMENT '关联记录ID',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `expire_at` DATETIME DEFAULT NULL COMMENT '过期时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_alert_type` (`alert_type`),
  KEY `idx_is_read` (`is_read`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='告警信息表';
```

### 1.11 appeal - 申诉记录表

```sql
CREATE TABLE `appeal` (
  `id` VARCHAR(36) NOT NULL COMMENT '申诉ID(UUID)',
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `alert_id` VARCHAR(36) NOT NULL COMMENT '关联告警ID',
  `appeal_type` VARCHAR(30) NOT NULL COMMENT '申诉类型:clone_plate/violation/fee/other',
  `reason` TEXT NOT NULL COMMENT '申诉原因',
  `proof_images` JSON DEFAULT NULL COMMENT '证明材料URL数组',
  `status` VARCHAR(20) DEFAULT 'pending' COMMENT '状态:pending/approved/rejected',
  `result` TEXT DEFAULT NULL COMMENT '处理结果',
  `handle_time` DATETIME DEFAULT NULL COMMENT '处理时间',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_alert_id` (`alert_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='申诉记录表';
```

### 1.12 bill - 账单表

```sql
CREATE TABLE `bill` (
  `id` VARCHAR(36) NOT NULL COMMENT '账单ID(UUID)',
  `owner_id` BIGINT NOT NULL COMMENT '车主ID',
  `vehicle_id` VARCHAR(36) DEFAULT NULL COMMENT '车辆ID(空表示全部)',
  `bill_month` VARCHAR(7) NOT NULL COMMENT '账单月份(yyyy-MM)',
  `total_count` INT DEFAULT 0 COMMENT '总通行次数',
  `total_fee` DECIMAL(12,2) DEFAULT 0.00 COMMENT '总费用',
  `total_distance` DECIMAL(12,2) DEFAULT 0.00 COMMENT '总里程(km)',
  `payment_status` VARCHAR(20) DEFAULT 'unpaid' COMMENT '支付状态',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_owner_vehicle_month` (`owner_id`, `vehicle_id`, `bill_month`),
  KEY `idx_bill_month` (`bill_month`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='账单表';
```

### 1.13 invoice_record - 发票记录表

```sql
CREATE TABLE `invoice_record` (
  `id` VARCHAR(36) NOT NULL COMMENT '发票ID(UUID)',
  `owner_id` BIGINT NOT NULL COMMENT '申请人ID',
  `bill_month` VARCHAR(7) NOT NULL COMMENT '账单月份',
  `amount` DECIMAL(12,2) NOT NULL COMMENT '发票金额',
  `invoice_type` VARCHAR(20) NOT NULL COMMENT '发票类型:personal/company',
  `invoice_title` VARCHAR(100) NOT NULL COMMENT '发票抬头',
  `tax_number` VARCHAR(30) DEFAULT NULL COMMENT '税号',
  `email` VARCHAR(100) NOT NULL COMMENT '接收邮箱',
  `status` VARCHAR(20) DEFAULT 'pending' COMMENT '状态:pending/processing/completed/failed',
  `invoice_url` VARCHAR(255) DEFAULT NULL COMMENT '发票下载地址',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_owner_id` (`owner_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='发票记录表';
```

### 1.14 query_history - 查询历史表

```sql
CREATE TABLE `query_history` (
  `id` VARCHAR(36) NOT NULL COMMENT '记录ID(UUID)',
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `query_text` TEXT NOT NULL COMMENT '自然语言查询',
  `generated_sql` TEXT NOT NULL COMMENT '生成的SQL',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='查询历史表';
```

---

## 二、HBase 表结构

### 2.1 etc:pass_record - 通行明细表

**RowKey 设计**：`{salt(2)}{yyyyMMdd}{checkpoint_id}{reverse_ts}{plate_prefix}`

| 列族 | 列名 | 类型 | 说明 |
|------|------|------|------|
| d | plate | String | 车牌号 |
| d | vtype | String | 车辆类型 |
| d | entry_cp | String | 入口卡口ID |
| d | entry_time | Long | 入口时间戳 |
| d | exit_cp | String | 出口卡口ID |
| d | exit_time | Long | 出口时间戳 |
| d | fee | Int | 费用(分) |
| d | distance | Int | 里程(米) |
| d | speed | Int | 平均速度 |
| d | province | String | 省份 |

```shell
create 'etc:pass_record', 
  {NAME => 'd', VERSIONS => 1, COMPRESSION => 'SNAPPY', TTL => 31536000}
```

### 2.2 etc:vehicle_trajectory - 车辆轨迹表

**RowKey 设计**：`{plate_hash(4)}{plate_number}{reverse_ts}`

| 列族 | 列名 | 类型 | 说明 |
|------|------|------|------|
| t | lng | Double | 经度 |
| t | lat | Double | 纬度 |
| t | cp_id | String | 卡口ID |
| t | cp_name | String | 卡口名称 |
| t | speed | Int | 速度 |

```shell
create 'etc:vehicle_trajectory', 
  {NAME => 't', VERSIONS => 1, COMPRESSION => 'SNAPPY', TTL => 7776000}
```

---

## 三、Redis 数据结构

### 3.1 会话管理

```
STRING  auth:token:{token}                 -> JSON{userId, username, roles, expires}  TTL:3600
HASH    session:{userId}                   -> {token, loginTime, lastAccessTime}
```

### 3.2 通行计数器（Flink 维护）

```
# ============ 车牌通行计数 ============
STRING  plate:count:{plateNumber}          -> 总通行次数(永久)
        例: plate:count:苏A12345 = 1234

STRING  plate:count:{date}:{plateNumber}   -> 当日通行次数  TTL:2days
        例: plate:count:20251220:苏A12345 = 5

# ============ 卡口通行计数 ============
STRING  cp:count:{checkpointId}            -> 总通行次数(永久)
        例: cp:count:CP001 = 9876543

STRING  cp:count:{date}:{checkpointId}     -> 当日通行次数  TTL:2days
        例: cp:count:20251220:CP001 = 2345

# ============ 用途说明 ============
# 1. 渐进式查询时快速返回总数（避免 HBase COUNT 全表扫描）
# 2. 实时大屏展示当日/累计流量
# 3. Flink 消费 Kafka 时实时 INCR 维护
```

### 3.3 实时统计（Flink 计算结果）

```
# 每日总览统计
HASH    stats:daily:{yyyyMMdd}             -> {totalCount, totalFee, totalDistance, localCount, foreignCount}

# 卡口实时流量
HASH    stats:checkpoint:{checkpointId}    -> {currentFlow, avgSpeed, updateTime, pressure}

# 小时级流量（前端折线图）
ZSET    stats:hourly:{checkpointId}        -> score:hourTimestamp, member:JSON{flow,speed,avgFee}  TTL:7days

# 区域热度排名
ZSET    stats:region:heat:{date}           -> score:flowCount, member:regionCode

# 车辆来源统计（本地/外地）
HASH    stats:vehicle:source:{date}        -> {local:12345, foreign:6789, province:{苏:xxx, 鲁:xxx, 皖:xxx}}
```

### 3.4 热点缓存

```
STRING  vehicle:{plateNumber}              -> JSON{vehicleInfo}  TTL:3600
HASH    checkpoint:all                     -> {checkpointId: JSON{info}}
STRING  user:{userId}                      -> JSON{userInfo}  TTL:1800
```

### 3.5 告警队列

```
LIST    alert:queue:{userId}               -> [alertMessage1, alertMessage2, ...]
PUBSUB  channel:alert:{userId}
STRING  alert:pressure:{checkpointId}      -> JSON{level, flow, threshold, time}  TTL:300
```

---

## 四、Kafka Topic

| Topic | 分区数 | 说明 |
|-------|--------|------|
| etc-pass-record | 6 | 通行记录流 |
| etc-violation | 3 | 违规事件流 |
| etc-clone-plate | 3 | 套牌车检测 |
| etc-alert | 3 | 告警通知流 |
| etc-checkpoint-flow | 6 | 卡口流量流 |

---

## 五、ShardingSphere 分片配置

```yaml
dataSources:
  ds_0:
    url: jdbc:mysql://mysql0:3306/etc?useSSL=false
    username: root
    password: ${MYSQL_PASSWORD}
  ds_1:
    url: jdbc:mysql://mysql1:3306/etc?useSSL=false
    username: root
    password: ${MYSQL_PASSWORD}

rules:
  - !SHARDING
    tables:
      pass_record:
        actualDataNodes: ds_${0..1}.pass_record_${0..1}
        tableStrategy:
          standard:
            shardingColumn: plate_hash
            shardingAlgorithmName: pass_record_mod
    shardingAlgorithms:
      pass_record_mod:
        type: MOD
        props:
          sharding-count: 2
```

---

## 六、初始化数据

```sql
-- 初始管理员账户
INSERT INTO `sys_user` (`username`, `password`, `nickname`, `user_type`, `status`) VALUES
('admin', '$2a$10$xxxxx', 'ETC管理员', 'admin', 1);

-- 初始角色
INSERT INTO `sys_role` (`role_code`, `role_name`, `description`) VALUES
('admin', '管理员', '系统管理员'),
('owner', '车主', '普通车主用户');

-- 车辆类型选项
-- small-小型车, medium-中型车, large-大型车, extra_large-特大型车, motorcycle-摩托车

-- 违规类型选项
-- clone_plate-套牌车, speeding-超速, wrong_way-逆行, red_light-闯红灯, no_seatbelt-未系安全带, other-其他

-- 通行状态选项
-- normal-正常, abnormal-异常, pending-待处理

-- 拥堵等级选项
-- smooth-畅通, low-轻度拥堵, medium-中度拥堵, high-严重拥堵
```

---

## 七、ER 图

```
sys_user ──┬── sys_user_role ──── sys_role
           │
           └── owner_vehicle ──── vehicle ──┬── pass_record
                                            │
checkpoint ─────────────────────────────────┤
                                            │
                                            ├── violation
                                            │
                                            └── clone_plate_detection

alert ──── appeal

bill ──── invoice_record
```
