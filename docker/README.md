# ETC å¤§æ•°æ®ç®¡ç†å¹³å° - Docker é›†ç¾¤éƒ¨ç½²æŒ‡å—

## ğŸ“‹ é›†ç¾¤æ¶æ„

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚              ETC å¤§æ•°æ®é›†ç¾¤                      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                               â”‚                           â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ZooKeeper â”‚                 â”‚    MySQL      â”‚           â”‚    HBase      â”‚
    â”‚  Cluster  â”‚                 â”‚   Cluster     â”‚           â”‚   Cluster     â”‚
    â”‚  (3èŠ‚ç‚¹)  â”‚                 â”‚   (2èŠ‚ç‚¹)     â”‚           â”‚   (2èŠ‚ç‚¹)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                               â”‚                           â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  zk-1     â”‚                 â”‚  mysql-1      â”‚           â”‚ hbase-master  â”‚
    â”‚  zk-2     â”‚                 â”‚  mysql-2      â”‚           â”‚ hbase-region  â”‚
    â”‚  zk-3     â”‚                 â”‚  sharding     â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚  proxy        â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                               â”‚                           â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Redis   â”‚                 â”‚    Kafka      â”‚           â”‚    Flink      â”‚
    â”‚  Cluster  â”‚                 â”‚               â”‚           â”‚   Cluster     â”‚
    â”‚  (2èŠ‚ç‚¹)  â”‚                 â”‚               â”‚           â”‚   (2èŠ‚ç‚¹)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¿«é€Ÿå¯åŠ¨

### 1. å‰ç½®æ¡ä»¶

- Docker Desktop å·²å®‰è£…å¹¶è¿è¡Œ
- è‡³å°‘ 8GB å¯ç”¨å†…å­˜
- è‡³å°‘ 20GB å¯ç”¨ç£ç›˜ç©ºé—´

### 2. å¯åŠ¨é›†ç¾¤

```bash
# è¿›å…¥ docker ç›®å½•
cd docker

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps
```

### 3. éªŒè¯æœåŠ¡

| æœåŠ¡ | ç«¯å£ | éªŒè¯å‘½ä»¤/URL |
|------|------|-------------|
| MySQL-1 | 3306 | `mysql -h localhost -P 3306 -u root -petc123456` |
| MySQL-2 | 3307 | `mysql -h localhost -P 3307 -u root -petc123456` |
| ShardingSphere | 3308 | `mysql -h localhost -P 3308 -u root -petc123456` |
| Redis-1 | 6379 | `redis-cli -p 6379 -a etc123456 ping` |
| Redis-2 | 6380 | `redis-cli -p 6380 -a etc123456 ping` |
| HBase Master | 16010 | http://localhost:16010 |
| Flink Dashboard | 8082 | http://localhost:8082 |
| ZooKeeper | 2181 | `echo ruok | nc localhost 2181` |
| Kafka | 9092 | `kafka-topics.sh --list --bootstrap-server localhost:9092` |

## ğŸ“Š æ•°æ®åˆ†ç‰‡ç­–ç•¥

### MySQL åˆ†ç‰‡ (ShardingSphere)

| è¡¨å | åˆ†ç‰‡é”® | åˆ†ç‰‡ç®—æ³• | è¯´æ˜ |
|------|--------|----------|------|
| pass_record | checkpoint_id | MOD(2) | æŒ‰å¡å£IDå–æ¨¡åˆ†ç‰‡ |
| violation | id | MOD(2) | æŒ‰IDå–æ¨¡åˆ†ç‰‡ |
| clone_plate_detection | id | MOD(2) | æŒ‰IDå–æ¨¡åˆ†ç‰‡ |
| checkpoint_flow | checkpoint_id | MOD(2) | æŒ‰å¡å£IDå–æ¨¡åˆ†ç‰‡ |

### å¹¿æ’­è¡¨ (æ‰€æœ‰èŠ‚ç‚¹éƒ½æœ‰å®Œæ•´æ•°æ®)

- sys_user - ç”¨æˆ·è¡¨
- sys_role - è§’è‰²è¡¨
- vehicle - è½¦è¾†è¡¨
- checkpoint - å¡å£è¡¨
- station - æ”¶è´¹ç«™è¡¨
- alert - å‘Šè­¦è¡¨
- appeal - ç”³è¯‰è¡¨

### HBase è¡¨è®¾è®¡

| è¡¨å | RowKey è®¾è®¡ | åˆ—æ— |
|------|------------|------|
| pass_record | checkpoint_id + reverse_timestamp | cf:info |
| realtime_flow | checkpoint_id + timestamp | cf:flow |

## ğŸ”§ å¸¸ç”¨å‘½ä»¤

### å¯åŠ¨/åœæ­¢

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose down

# é‡å¯å•ä¸ªæœåŠ¡
docker-compose restart mysql-1

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f mysql-1

# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çŠ¶æ€
docker-compose ps
```

### æ•°æ®åº“è¿æ¥

```bash
# è¿æ¥ MySQL (é€šè¿‡åˆ†ç‰‡ä»£ç†)
mysql -h localhost -P 3308 -u root -petc123456 -D etc_db

# è¿æ¥ Redis
redis-cli -p 6379 -a etc123456

# è¿æ¥ HBase Shell
docker exec -it etc-hbase-master hbase shell
```

### æ•°æ®å¯¼å…¥

```bash
# åˆå§‹åŒ–æ•°æ®å·²åœ¨ init/mysql/01-init.sql ä¸­
# å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ‰§è¡Œ
```

## ğŸ“ˆ æ€§èƒ½è°ƒä¼˜

### MySQL é…ç½®

- å¼€å¯ binlog (ROW æ ¼å¼)
- å­—ç¬¦é›† utf8mb4
- InnoDB å­˜å‚¨å¼•æ“

### Redis é…ç½®

- AOF æŒä¹…åŒ–
- å¯†ç è®¤è¯

### Kafka é…ç½®

- è‡ªåŠ¨åˆ›å»º Topic
- KRaft æ¨¡å¼ (æ— éœ€ ZooKeeper)

## ğŸ”’ å®‰å…¨é…ç½®

| ç»„ä»¶ | ç”¨æˆ·å | å¯†ç  |
|------|--------|------|
| MySQL | root | etc123456 |
| MySQL | etc_user | etc123456 |
| Redis | - | etc123456 |
| ShardingSphere | root | etc123456 |

## ğŸ“ ç›®å½•ç»“æ„

```
docker/
â”œâ”€â”€ docker-compose.yml          # Docker Compose é…ç½®
â”œâ”€â”€ init/
â”‚   â””â”€â”€ mysql/
â”‚       â””â”€â”€ 01-init.sql         # MySQL åˆå§‹åŒ–è„šæœ¬
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ shardingsphere/
â”‚   â”‚   â”œâ”€â”€ server.yaml         # ShardingSphere æœåŠ¡é…ç½®
â”‚   â”‚   â””â”€â”€ config-sharding.yaml # åˆ†ç‰‡é…ç½®
â”‚   â””â”€â”€ hbase/
â”‚       â””â”€â”€ hbase-site.xml      # HBase é…ç½®
â””â”€â”€ README.md                   # æœ¬æ–‡æ¡£
```

## ğŸ› ï¸ æ•…éšœæ’é™¤

### æœåŠ¡å¯åŠ¨å¤±è´¥

```bash
# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker-compose logs <service-name>

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -ano | findstr "3306"
```

### å†…å­˜ä¸è¶³

ä¿®æ”¹ Docker Desktop å†…å­˜é…ç½®ï¼Œå»ºè®®è‡³å°‘ 8GBã€‚

### ç½‘ç»œé—®é¢˜

```bash
# é‡å»ºç½‘ç»œ
docker-compose down
docker network prune
docker-compose up -d
```
