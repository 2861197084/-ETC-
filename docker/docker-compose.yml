# ETC 大数据管理平台 - 完整集群配置
# 课程：大数据存储与管理
# 所有服务真实运行，无 Mock 数据

services:
  # ==================== ZooKeeper 集群 (3节点) ====================
  zookeeper-1:
    image: zookeeper:3.8
    container_name: etc-zk-1
    hostname: zookeeper-1
    ports:
      - "2181:2181"
    environment:
      ZOO_MY_ID: 1
      ZOO_SERVERS: server.1=zookeeper-1:2888:3888;2181 server.2=zookeeper-2:2888:3888;2181 server.3=zookeeper-3:2888:3888;2181
    volumes:
      - zk1-data:/data
      - zk1-datalog:/datalog
    networks:
      - etc-network
    restart: unless-stopped

  zookeeper-2:
    image: zookeeper:3.8
    container_name: etc-zk-2
    hostname: zookeeper-2
    ports:
      - "2182:2181"
    environment:
      ZOO_MY_ID: 2
      ZOO_SERVERS: server.1=zookeeper-1:2888:3888;2181 server.2=zookeeper-2:2888:3888;2181 server.3=zookeeper-3:2888:3888;2181
    volumes:
      - zk2-data:/data
      - zk2-datalog:/datalog
    networks:
      - etc-network
    restart: unless-stopped

  zookeeper-3:
    image: zookeeper:3.8
    container_name: etc-zk-3
    hostname: zookeeper-3
    ports:
      - "2183:2181"
    environment:
      ZOO_MY_ID: 3
      ZOO_SERVERS: server.1=zookeeper-1:2888:3888;2181 server.2=zookeeper-2:2888:3888;2181 server.3=zookeeper-3:2888:3888;2181
    volumes:
      - zk3-data:/data
      - zk3-datalog:/datalog
    networks:
      - etc-network
    restart: unless-stopped

  # ==================== MySQL 分片集群 (2节点) ====================
  mysql-1:
    image: mysql:8.0
    container_name: etc-mysql-1
    hostname: mysql-1
    ports:
      - "13306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: etc123456
      MYSQL_DATABASE: etc_db
      MYSQL_USER: etc_user
      MYSQL_PASSWORD: etc123456
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --server-id=1
      - --log-bin=mysql-bin
      - --binlog-format=ROW
    volumes:
      - mysql1-data:/var/lib/mysql
      - ./init/mysql:/docker-entrypoint-initdb.d
    networks:
      - etc-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-petc123456"]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  mysql-2:
    image: mysql:8.0
    container_name: etc-mysql-2
    hostname: mysql-2
    ports:
      - "13307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: etc123456
      MYSQL_DATABASE: etc_db
      MYSQL_USER: etc_user
      MYSQL_PASSWORD: etc123456
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --server-id=2
      - --log-bin=mysql-bin
      - --binlog-format=ROW
    volumes:
      - mysql2-data:/var/lib/mysql
      - ./init/mysql:/docker-entrypoint-initdb.d
    networks:
      - etc-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-petc123456"]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  # ==================== HBase 单机模式 ====================
  hbase:
    image: harisekhon/hbase:2.1
    container_name: etc-hbase
    hostname: hbase
    ports:
      - "16000:16000"
      - "16010:16010"
      - "16020:16020"
      - "16030:16030"
      - "9090:9090"
      - "9095:9095"
      - "8084:8080"
      - "8085:8085"
    volumes:
      - hbase-data:/hbase-data
    networks:
      - etc-network
    restart: unless-stopped

  # ==================== Redis 集群 (2节点) ====================
  redis-1:
    image: redis:7-alpine
    container_name: etc-redis-1
    hostname: redis-1
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --requirepass etc123456
    volumes:
      - redis1-data:/data
    networks:
      - etc-network
    restart: unless-stopped

  redis-2:
    image: redis:7-alpine
    container_name: etc-redis-2
    hostname: redis-2
    ports:
      - "6380:6379"
    command: redis-server --appendonly yes --requirepass etc123456
    volumes:
      - redis2-data:/data
    networks:
      - etc-network
    restart: unless-stopped

  # ==================== Kafka (KRaft 模式) ====================
  kafka:
    image: apache/kafka:latest
    container_name: etc-kafka
    hostname: kafka
    ports:
      - "9092:9092"
      - "9093:9093"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      CLUSTER_ID: 'MkU3OEVBNTcwNTJENDM2Qk'
    volumes:
      - kafka-data:/var/lib/kafka/data
    networks:
      - etc-network
    restart: unless-stopped

  # ==================== Flink ====================
  flink-jobmanager:
    image: flink:1.18-java11
    container_name: etc-flink-jobmanager
    hostname: flink-jobmanager
    ports:
      - "8083:8081"
    command: jobmanager
    environment:
      FLINK_PROPERTIES: |
        jobmanager.rpc.address: flink-jobmanager
        parallelism.default: 2
    volumes:
      - flink-data:/opt/flink/data
    networks:
      - etc-network
    restart: unless-stopped

  flink-taskmanager:
    image: flink:1.18-java11
    container_name: etc-flink-taskmanager
    hostname: flink-taskmanager
    command: taskmanager
    environment:
      FLINK_PROPERTIES: |
        jobmanager.rpc.address: flink-jobmanager
        taskmanager.numberOfTaskSlots: 4
        parallelism.default: 2
    depends_on:
      - flink-jobmanager
    networks:
      - etc-network
    restart: unless-stopped

# ==================== 网络 ====================
networks:
  etc-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# ==================== 数据卷 ====================
volumes:
  zk1-data:
  zk1-datalog:
  zk2-data:
  zk2-datalog:
  zk3-data:
  zk3-datalog:
  mysql1-data:
  mysql2-data:
  hbase-data:
  redis1-data:
  redis2-data:
  kafka-data:
  flink-data:
