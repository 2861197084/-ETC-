# ETC 高速公路大数据平台 - 设计文档

> 本文档记录项目各部分的标准业务逻辑、接口 API 及技术设计。

---

## 1. 系统架构

### 1.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         展示层                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │   门户首页   │  │   数据大屏   │  │  交互式查询  │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│  ┌─────────────┐  ┌─────────────┐                               │
│  │   离线预测   │  │   车主端     │                               │
│  └─────────────┘  └─────────────┘                               │
├─────────────────────────────────────────────────────────────────┤
│                         服务层                                   │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐   │
│  │ 查询服务   │ │ 告警服务   │ │ 预测服务   │ │ 大屏服务   │   │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘   │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐                   │
│  │ 认证服务   │ │ 路线服务   │ │ 数据接入   │                   │
│  └────────────┘ └────────────┘ └────────────┘                   │
├─────────────────────────────────────────────────────────────────┤
│                         处理层                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │              Flink 实时处理                              │    │
│  │  ETL清洗 │ 窗口聚合 │ 套牌检测 │ 拥堵预警                │    │
│  └─────────────────────────────────────────────────────────┘    │
├─────────────────────────────────────────────────────────────────┤
│                         存储层                                   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │  Kafka   │  │  HBase   │  │  MySQL   │  │  Redis   │        │
│  │  消息队列 │  │  明细存储 │  │  分片存储 │  │  缓存    │        │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 技术选型

| 层级 | 技术 | 用途 |
|-----|------|------|
| 前端 | Vue 3 + Vite | 单页应用框架 |
| 前端 | ECharts | 数据可视化 |
| 前端 | Element Plus + Naive UI | UI组件库（混合使用） |
| 后端 | Python/Java | API 服务 |
| 消息 | Kafka | 实时数据管道 |
| 处理 | Flink | 流式计算 |
| 存储 | HBase | 明细数据存储 |
| 存储 | MySQL + ShardingSphere | 聚合数据分片存储 |
| 缓存 | Redis | 热点数据缓存 |

---

## 2. 前端设计

### 2.1 页面结构

```
/                   # 系统首页（继承自开源框架）
/etc/monitor        # ETC实时监控指挥舱
/etc/query          # 数据查询中心
/etc/prediction     # 离线预测分析
```

> 注：本项目基于开源项目 art-design-pro 进行开发，保留了原框架的布局和部分组件，通过路由配置隐藏了无关模块的菜单显示。

### 2.2 组件设计

#### 2.2.1 大屏组件

| 组件 | 文件路径 | 功能 |
|-----|---------|------|
| KPIStatCard | `components/dashboard/KPIStatCard.vue` | KPI 指标卡，支持数字滚动 |
| DigitalClock | `components/dashboard/DigitalClock.vue` | 数字时钟，实时更新 |
| AlertTicker | `components/dashboard/AlertTicker.vue` | 告警滚动列表 |

#### 2.2.2 图表组件

| 组件 | 文件路径 | 功能 |
|-----|---------|------|
| ChinaMapChart | `components/charts/ChinaMapChart.vue` | 中国地图热力图 |
| TrendLineChart | `components/charts/TrendLineChart.vue` | 趋势折线/柱状图 |
| RingPieChart | `components/charts/RingPieChart.vue` | 环形饼图 |
| BarRankChart | `components/charts/BarRankChart.vue` | 横向排行条形图 |
| Bar3DChart | `components/charts/Bar3DChart.vue` | 柱状图 |

### 2.3 Design Tokens

```scss
// 颜色系统
$color-primary: #00d4ff;      // 主色
$color-success: #00ff88;      // 成功
$color-warning: #ffaa00;      // 警告
$color-danger: #ff6b35;       // 危险

// 大屏背景
$dashboard-bg: #0a1628;
$dashboard-card-bg: rgba(6, 30, 61, 0.8);
$dashboard-border: rgba(30, 144, 255, 0.3);

// 字体
$font-din: 'DIN Alternate';   // 数字字体
$font-sans: 'Source Han Sans CN';  // 中文字体
```

---

## 3. API 接口设计

### 3.1 大屏接口

#### GET /api/dashboard/overview

大屏概览数据，30秒刷新一次。

**响应示例**：

```json
{
  "code": 0,
  "data": {
    "totalVehicles": 27619,
    "smallVehicles": 11076,
    "largeVehicles": 16543,
    "stationStats": [
      { "name": "松山湖南", "value": 3165, "percentage": "32.82%" }
    ],
    "vehicleTypes": [
      { "name": "三型车(客)", "value": 2927, "color": "#00d4ff" }
    ],
    "hourlyFlow": [
      { "hour": "0am", "vehicleType": "客车", "count": 1200 }
    ],
    "recentAlerts": [
      {
        "id": 1,
        "stationName": "松山湖南",
        "location": "深圳市",
        "time": "2024-01-02 13:48:01",
        "alertValue": "27.00",
        "status": "warning",
        "content": "流量告警"
      }
    ],
    "mapData": [
      { "name": "广东", "value": 800 }
    ],
    "alertTrend": [
      { "time": "13:39", "value": 32, "station": "罗田主线站" }
    ],
    "updateTime": "2024-01-02 13:48:02"
  }
}
```

### 3.2 查询接口

#### GET /api/query/plate/{plateNo}

按车牌查询最近轨迹。

**请求参数**：

| 参数 | 类型 | 必填 | 说明 |
|-----|------|------|------|
| plateNo | string | 是 | 车牌号码 |
| limit | number | 否 | 返回条数，默认50 |

#### GET /api/query/gantry/{gantryId}

按门架/卡口查询过车记录。

**请求参数**：

| 参数 | 类型 | 必填 | 说明 |
|-----|------|------|------|
| gantryId | string | 是 | 门架/卡口ID |
| start | datetime | 否 | 开始时间 |
| end | datetime | 否 | 结束时间 |

### 3.3 告警接口

#### GET /api/alerts

查询告警列表。

**请求参数**：

| 参数 | 类型 | 必填 | 说明 |
|-----|------|------|------|
| type | string | 否 | 告警类型：CLONE/CONGESTION/DEVICE |
| level | string | 否 | 告警等级：HIGH/MEDIUM/LOW |
| start | datetime | 否 | 开始时间 |
| end | datetime | 否 | 结束时间 |

#### POST /api/alerts/{id}/actions

处置告警。

**请求体**：

```json
{
  "action": "confirm",  // confirm/dismiss/dispatch
  "remark": "已核实为套牌车"
}
```

### 3.4 预测接口

#### GET /api/predict/station/{stationId}

获取站点车流预测。

**请求参数**：

| 参数 | 类型 | 必填 | 说明 |
|-----|------|------|------|
| stationId | string | 是 | 站点ID |
| horizon | string | 否 | 预测时长：15m/30m/60m |

**响应示例**：

```json
{
  "code": 0,
  "data": {
    "stationId": "S001",
    "stationName": "罗田主线站",
    "predictions": [
      {
        "time": "14:00",
        "predicted": 23.64,
        "lower": 20.12,
        "upper": 27.16,
        "riskLevel": "high"
      }
    ],
    "suggestions": [
      "车流量较高，建议开放更多卡口"
    ]
  }
}
```

---

## 4. 数据模型设计

### 4.1 过车事件表 (HBase)

**表名**：`t_pass_event`

**RowKey 设计**：`{salt}#{plate_no}#{reverse_ts}`

| 列族 | 列名 | 类型 | 说明 |
|-----|------|------|------|
| cf | event_id | string | 事件ID |
| cf | event_time | long | 事件时间戳 |
| cf | plate_no | string | 车牌号码 |
| cf | plate_color | string | 车牌颜色 |
| cf | vehicle_type | string | 车辆类型 |
| cf | gantry_id | string | 门架ID |
| cf | direction | string | 方向 |
| cf | speed_kmh | int | 速度 |

### 4.2 聚合指标表 (MySQL)

**表名**：`agg_station_flow_yyyyMM`

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | bigint | 主键 |
| station_id | varchar(32) | 站点ID |
| time_bucket | datetime | 时间桶（分钟级） |
| total_count | int | 总车流量 |
| passenger_count | int | 客车数量 |
| freight_count | int | 货车数量 |
| avg_speed | decimal | 平均速度 |

### 4.3 告警事件表 (MySQL)

**表名**：`alert_event_yyyyMM`

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | bigint | 主键 |
| alert_type | varchar(32) | 告警类型 |
| alert_level | varchar(16) | 告警等级 |
| station_id | varchar(32) | 关联站点 |
| plate_no | varchar(16) | 关联车牌 |
| created_at | datetime | 创建时间 |
| status | varchar(16) | 状态 |
| evidence | text | 证据链JSON |

---

## 5. 套牌检测算法

### 5.1 算法逻辑

```
输入：过车事件流 (plate_no, event_time, gantry_id, lat, lon)

1. 按 plate_no 分组，维护最近 N 次过车记录
2. 对于新事件，与历史记录比较：
   - 计算两点距离 d = haversine(p1, p2)
   - 计算时间差 Δt = t2 - t1
   - 计算最小可达时间 t_min = d / v_max (v_max = 120km/h)
3. 判断条件：
   - 如果 Δt < t_min * α (α = 0.8)，触发告警
4. 输出告警：
   - 两点事件详情
   - 距离、时间差、最小可达时间
   - 置信度 = sigmoid((t_min - Δt) / t_min)
```

### 5.2 Flink 实现要点

- 使用 KeyedProcessFunction，按车牌分组
- 维护 ValueState 存储历史事件
- 使用事件时间 + Watermark 处理乱序
- 窗口大小：10分钟

---

## 6. 大屏刷新机制

### 6.1 刷新策略

```javascript
// 前端 30秒轮询
const REFRESH_INTERVAL = 30000

onMounted(() => {
  fetchData()
  refreshTimer = setInterval(fetchData, REFRESH_INTERVAL)
})

onUnmounted(() => {
  clearInterval(refreshTimer)
})
```

### 6.2 降级策略

1. 接口超时 > 5秒，使用上次缓存数据
2. 显示"数据延迟 xx 秒"提示
3. 连续失败 3 次，显示降级提示

---

*文档版本：v1.0*
*最后更新：2024-12-16*

