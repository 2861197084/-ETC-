# ETC 平台项目实现总结

## 一、问题背景

前端查询页面（统计维度）查不到数据，原因是数据存储在分片表中，需要通过 ShardingSphere 代理访问。

## 二、已完成的工作

### 1. 数据库分片结构确认

| 数据库节点 | 端口 | 数据库 | 表名 | 记录数 |
|-----------|------|--------|------|--------|
| mysql0 | 33070 | etc | pass_record_0 | 540,169 |
| mysql1 | 33061 | etc | pass_record_1 | 539,831 |

**总数据量**: 1,080,000 条过车记录

### 2. 数据库字段映射修复

数据库实际使用中文/拼音字段名，与 JPA 实体不匹配，已修复映射：

| 数据库字段 | JPA 属性 | 含义 |
|-----------|----------|------|
| `hp` | `plateNumber` | 车牌号 |
| `gcsj` | `passTime` | 过车时间 |
| `kkmc` | `checkpointName` | 卡口名称 |
| `fxlx` | `directionType` | 方向类型 |
| `hpzl` | `plateType` | 号牌种类 |
| `checkpoint_id` | `checkpointIdStr` | 卡口ID (格式 "CP001") |

**已修改文件**: `backend/src/main/java/com/etc/platform/entity/PassRecord.java`

### 3. ShardingSphere 配置修复

**配置文件**: `infra/shardingsphere/conf/config-sharding.yaml`

```yaml
databaseName: etc

dataSources:
  ds_0:
    url: jdbc:mysql://mysql0:3306/etc?useSSL=false&allowPublicKeyRetrieval=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
    username: root
    password: root
    connectionTimeoutMilliseconds: 30000
    idleTimeoutMilliseconds: 60000
    maxLifetimeMilliseconds: 1800000
    maxPoolSize: 30
    minPoolSize: 1
  ds_1:
    url: jdbc:mysql://mysql1:3306/etc?useSSL=false&allowPublicKeyRetrieval=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
    username: root
    password: root
    connectionTimeoutMilliseconds: 30000
    idleTimeoutMilliseconds: 60000
    maxLifetimeMilliseconds: 1800000
    maxPoolSize: 30
    minPoolSize: 1

rules:
  - !SHARDING
    tables:
      pass_record:
        actualDataNodes: ds_${0..1}.pass_record_${0..1}
        databaseStrategy:
          standard:
            shardingColumn: plate_hash
            shardingAlgorithmName: pass_record_db_inline
        tableStrategy:
          standard:
            shardingColumn: plate_hash
            shardingAlgorithmName: pass_record_tbl_inline
        keyGenerateStrategy:
          column: id
          keyGeneratorName: snowflake
    shardingAlgorithms:
      pass_record_db_inline:
        type: INLINE
        props:
          algorithm-expression: ds_${plate_hash % 2}
      pass_record_tbl_inline:
        type: INLINE
        props:
          algorithm-expression: pass_record_${plate_hash % 2}
    keyGenerators:
      snowflake:
        type: SNOWFLAKE
```

### 4. Docker 配置修改

**docker-compose.yml** 已修改为使用官方镜像：

```yaml
shardingsphere:
  image: apache/shardingsphere-proxy:5.4.1
  depends_on:
    mysql0:
      condition: service_healthy
    mysql1:
      condition: service_healthy
  ports:
    - "3307:3307"
  volumes:
    - ./infra/shardingsphere/conf:/opt/shardingsphere-proxy/conf
    - ./infra/shardingsphere/ext-lib:/opt/shardingsphere-proxy/ext-lib
  environment:
    JAVA_OPTS: "-Xms512m -Xmx1024m"
  healthcheck:
    test: ["CMD-SHELL", "bash -lc 'exec 3<>/dev/tcp/127.0.0.1/3307'"]
    interval: 10s
    timeout: 5s
    retries: 18
```

**MySQL 驱动**: 已下载到 `infra/shardingsphere/ext-lib/mysql-connector-j-8.4.0.jar`

---

## 三、待完成的工作

### 1. 启动 ShardingSphere 容器

ShardingSphere 配置已正确，手动运行 Java 进程测试成功：

```
[INFO] ShardingSphere-Proxy Standalone mode started successfully
```

但容器因 `start.sh` 后台启动问题会自动退出。

**解决方案**:

- 方案 A: 已修改 `infra/shardingsphere/Dockerfile` 直接运行 Java（需重新构建镜像）
- 方案 B: 使用官方镜像（已配置在 docker-compose.yml），需确保网络通畅后重启

**Dockerfile 修改内容** (方案 A):

```dockerfile
# 原来的 CMD
CMD ["/opt/shardingsphere-proxy/bin/start.sh"]

# 修改为直接运行 Java 进程（保持前台运行）
CMD ["java", "-classpath", "/opt/shardingsphere-proxy/conf:/opt/shardingsphere-proxy/lib/*:/opt/shardingsphere-proxy/ext-lib/*", "-Xms512m", "-Xmx1024m", "org.apache.shardingsphere.proxy.Bootstrap", "3307", "/opt/shardingsphere-proxy/conf"]
```

### 2. 后端连接配置

确认后端 `application.yml` 是否连接到 ShardingSphere 代理 (端口 3307)：

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3307/etc?useSSL=false&allowPublicKeyRetrieval=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
    username: root
    password: root
    driver-class-name: com.mysql.cj.jdbc.Driver
```

### 3. 验证查询功能

- 启动后端: `cd backend && mvn spring-boot:run`
- 访问前端查询页面，测试数据是否正常显示

---

## 四、关键文件列表

| 文件 | 状态 | 说明 |
|------|------|------|
| `infra/shardingsphere/conf/config-sharding.yaml` | ✅ 已修复 | 分片规则配置 |
| `infra/shardingsphere/conf/server.yaml` | ✅ 已存在 | 服务器配置 |
| `infra/shardingsphere/ext-lib/mysql-connector-j-8.4.0.jar` | ✅ 已下载 | MySQL 驱动 |
| `infra/shardingsphere/Dockerfile` | ⚠️ 已修改 | 改为直接运行 Java |
| `docker-compose.yml` | ✅ 已修改 | 使用官方镜像 |
| `backend/.../entity/PassRecord.java` | ✅ 已修改 | 字段映射 |
| `backend/.../repository/PassRecordRepository.java` | ✅ 已修改 | 查询方法 |

---

## 五、快速启动步骤

```powershell
# 1. 进入项目目录
cd f:\ETC\-ETC-

# 2. 启动基础服务 (MySQL)
docker-compose up -d mysql0 mysql1

# 3. 等待 MySQL 健康检查通过
docker-compose ps

# 4. 启动 ShardingSphere
docker-compose up -d shardingsphere

# 5. 检查 ShardingSphere 状态
docker-compose ps shardingsphere
docker-compose logs shardingsphere --tail=50

# 6. 启动后端 (新终端)
cd backend
mvn spring-boot:run

# 7. 启动前端 (新终端)
cd frontend
pnpm dev
```

---

## 六、问题排查

### ShardingSphere 容器立即退出

1. 检查日志:
   ```powershell
   docker logs etc-platform-shardingsphere-1
   ```

2. 手动测试启动:
   ```powershell
   docker run --rm --network etc-platform_default -e JAVA_OPTS="-Xms512m -Xmx1024m" apache/shardingsphere-proxy:5.4.1 java -classpath "/opt/shardingsphere-proxy/conf:/opt/shardingsphere-proxy/lib/*:/opt/shardingsphere-proxy/ext-lib/*" org.apache.shardingsphere.proxy.Bootstrap 3307 /opt/shardingsphere-proxy/conf
   ```

### 后端连接失败

1. 确认 ShardingSphere 端口 3307 可访问
2. 检查 `application.yml` 数据源配置
3. 确认数据库 `etc` 存在

### 查询无数据

1. 确认通过 ShardingSphere 连接而非直接连接 MySQL
2. 检查 `pass_record` 逻辑表是否正确路由到 `pass_record_0` 和 `pass_record_1`
3. 验证字段映射是否正确

---

## 七、技术栈

- **数据库**: MySQL 8.4 (双节点分片)
- **分片中间件**: Apache ShardingSphere Proxy 5.4.1
- **后端**: Spring Boot + JPA
- **前端**: Vue 3 + Vite + TypeScript
- **容器**: Docker Compose

---

## 八、联系下一步开发者

主要任务：
1. **确保 ShardingSphere 容器保持运行** - 解决后台进程退出问题
2. **验证后端连接** - 通过 3307 端口连接 ShardingSphere
3. **测试前端查询** - 确认数据正常显示

**注意**: 所有配置已就绪，核心问题是 ShardingSphere 容器需要以前台模式运行 Java 进程。
